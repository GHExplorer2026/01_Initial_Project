From e442dfd8d2ea818cb0a155a0b3f6c1069a2550cf Mon Sep 17 00:00:00 2001
From: Codex Bot <codex-bot@example.com>
Date: Mon, 9 Feb 2026 00:26:05 +0100
Subject: [PATCH] fix(api): always include meta.sourceMode and meta.sourcesUsed

---
 src/core/types.ts          |  2 ++
 src/server/orchestrator.ts | 26 +++++++++++++++++++++++++-
 src/server/sourceMode.ts   |  6 ++++++
 tests/orchestrator.test.ts | 26 +++++++++++++++++++++++++-
 4 files changed, 58 insertions(+), 2 deletions(-)
 create mode 100644 src/server/sourceMode.ts

diff --git a/src/core/types.ts b/src/core/types.ts
index 6b8d642..ff664f1 100644
--- a/src/core/types.ts
+++ b/src/core/types.ts
@@ -100,6 +100,8 @@ export type WeeklyOutput = {
     generatedAtISO: string;
     weekStartBerlinISO: string;
     weekEndBerlinISO: string;
+    sourceMode: "fixtures" | "live";
+    sourcesUsed: string[];
   };
   icsPayload: string;
 };
diff --git a/src/server/orchestrator.ts b/src/server/orchestrator.ts
index 206a722..0e61469 100644
--- a/src/server/orchestrator.ts
+++ b/src/server/orchestrator.ts
@@ -7,6 +7,7 @@ import { normalizeEvents } from "@/core/normalize";
 import { renderStrictWeeklyText } from "@/core/rendererStrictDe";
 import type { EconomicEvent, RawSourceEvent, RegionCode, WeeklyOutput } from "@/core/types";
 import { resolveWeekInBerlin } from "@/core/weekResolver";
+import { resolveSourceMode } from "@/server/sourceMode";
 import { fetchInvestingEvents } from "@/server/sources/investing";
 import { fetchTradingViewEvents } from "@/server/sources/tradingview";
 import { fetchApprovedTertiaryEvents } from "@/server/sources/tertiary/approved";
@@ -41,6 +42,7 @@ export type GenerateParams = {
 
 export const generateWeeklyOutlook = async ({ regions, now }: GenerateParams): Promise<WeeklyOutput> => {
   const week = resolveWeekInBerlin(now ?? new Date());
+  const sourceMode = resolveSourceMode();
 
   const [investing, tradingview] = await Promise.all([
     fetchInvestingEvents(week.weekStart, week.weekEnd, regions),
@@ -73,6 +75,26 @@ export const generateWeeklyOutlook = async ({ regions, now }: GenerateParams): P
   const rendered = renderStrictWeeklyText(week, grouped, dayStatus, dataReliable);
   const icsPayload = generateIcs(filteredEvents, week.weekStart, PARSER_VERSION);
 
+  const sourcesUsed: string[] = [];
+  if (investing.ok || investing.events.length > 0) {
+    sourcesUsed.push("investing");
+  }
+  if (tradingview.ok || tradingview.events.length > 0) {
+    sourcesUsed.push("tradingview");
+  }
+  if (needTertiary) {
+    const tertiarySources = new Set(
+      tertiary.events
+        .map((event) => event.source)
+        .filter((source): source is `tertiary:${string}` => source.startsWith("tertiary:"))
+    );
+    if (tertiarySources.size === 0) {
+      sourcesUsed.push("tertiary");
+    } else {
+      sourcesUsed.push(...tertiarySources);
+    }
+  }
+
   return {
     renderedText: rendered.renderedText,
     events: filteredEvents,
@@ -81,7 +103,9 @@ export const generateWeeklyOutlook = async ({ regions, now }: GenerateParams): P
       parserVersion: PARSER_VERSION,
       generatedAtISO: new Date().toISOString(),
       weekStartBerlinISO: `${week.weekStart}T00:00:00+01:00`,
-      weekEndBerlinISO: `${week.weekEnd}T23:59:59+01:00`
+      weekEndBerlinISO: `${week.weekEnd}T23:59:59+01:00`,
+      sourceMode,
+      sourcesUsed
     },
     icsPayload
   };
diff --git a/src/server/sourceMode.ts b/src/server/sourceMode.ts
new file mode 100644
index 0000000..316b31c
--- /dev/null
+++ b/src/server/sourceMode.ts
@@ -0,0 +1,6 @@
+export type SourceMode = "fixtures" | "live";
+
+const normalize = (value: string | undefined): string => (value ?? "").trim().toLowerCase();
+
+export const resolveSourceMode = (envValue = process.env.SOURCE_MODE): SourceMode =>
+  normalize(envValue) === "live" ? "live" : "fixtures";
diff --git a/tests/orchestrator.test.ts b/tests/orchestrator.test.ts
index 4d687cc..1cd674f 100644
--- a/tests/orchestrator.test.ts
+++ b/tests/orchestrator.test.ts
@@ -1,10 +1,18 @@
 import { readFileSync } from "node:fs";
 import path from "node:path";
-import { describe, expect, it } from "vitest";
+import { afterEach, describe, expect, it } from "vitest";
 import { generateWeeklyOutlook } from "@/server/orchestrator";
 
+const originalSourceMode = process.env.SOURCE_MODE;
+
+afterEach(() => {
+  process.env.SOURCE_MODE = originalSourceMode;
+});
+
 describe("generateWeeklyOutlook", () => {
   it("produces deterministic strict text and ics for fixture inputs", async () => {
+    delete process.env.SOURCE_MODE;
+
     const result = await generateWeeklyOutlook({
       regions: ["USA", "EZ", "UK", "JP", "CH", "CA", "AU", "NZ"],
       now: new Date("2026-02-10T10:00:00Z")
@@ -18,6 +26,9 @@ describe("generateWeeklyOutlook", () => {
 
     expect(result.icsPayload).toContain("CATEGORIES:Wirtschafts-Event");
     expect(result.icsPayload).toContain("DTSTAMP:20260208T230000Z");
+    expect(result.meta.sourceMode).toBe("fixtures");
+    expect(result.meta.sourcesUsed).toContain("investing");
+    expect(result.meta.sourcesUsed).toContain("tradingview");
 
     const second = await generateWeeklyOutlook({
       regions: ["USA", "EZ", "UK", "JP", "CH", "CA", "AU", "NZ"],
@@ -27,4 +38,17 @@ describe("generateWeeklyOutlook", () => {
     expect(result.renderedText).toBe(second.renderedText);
     expect(result.icsPayload).toBe(second.icsPayload);
   });
+
+  it("sets sourceMode live and reports used sources in live mode", async () => {
+    process.env.SOURCE_MODE = "live";
+
+    const result = await generateWeeklyOutlook({
+      regions: ["USA", "EZ"],
+      now: new Date("2026-02-10T10:00:00Z")
+    });
+
+    expect(result.meta.sourceMode).toBe("live");
+    expect(result.meta.sourcesUsed.length).toBeGreaterThan(0);
+    expect(result.meta.sourcesUsed.some((source) => source === "investing" || source === "tradingview")).toBe(true);
+  });
 });
-- 
2.43.0

