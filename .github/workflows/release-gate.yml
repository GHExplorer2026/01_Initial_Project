name: Release Gate

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "docs/release-gate-last-success.json"
  workflow_dispatch:
    inputs:
      target_ref:
        description: "Git ref to validate (branch, tag, or commit SHA)"
        required: false
        default: "main"

jobs:
  verify-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      NPM_CONFIG_REGISTRY: https://registry.npmjs.org/
      NODE_OPTIONS: --dns-result-order=ipv4first
      NPM_CONFIG_AUDIT: "false"
      NPM_CONFIG_FUND: "false"
      NPM_CONFIG_FETCH_RETRIES: "5"
      NPM_CONFIG_FETCH_RETRY_MINTIMEOUT: "20000"
      NPM_CONFIG_FETCH_RETRY_MAXTIMEOUT: "120000"

    steps:
      - name: Checkout target ref (manual)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_ref }}

      - name: Checkout current ref (push)
        if: github.event_name != 'workflow_dispatch'
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci --registry="$NPM_CONFIG_REGISTRY"

      - name: Run release verification gate
        run: npm run verify:release

      - name: Start app and run API smoke gate
        run: |
          npm run start -- --hostname 127.0.0.1 --port 3000 > /tmp/release-gate-app.log 2>&1 &
          APP_PID=$!
          for i in {1..30}; do
            if curl -fsS "http://127.0.0.1:3000/" >/dev/null; then
              break
            fi
            sleep 1
          done
          scripts/smoke_api.sh http://127.0.0.1:3000 USA,EZ
          kill "$APP_PID"

      - name: Upload release gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-gate-test-reports
          path: |
            artifacts/*.xml
            /tmp/release-gate-app.log

      - name: Record release gate marker
        if: always()
        run: |
          mkdir -p docs
          cat > docs/release-gate-last-success.json <<EOF
          {
            "workflow": "Release Gate",
            "status": "${{ job.status }}",
            "run_id": "${{ github.run_id }}",
            "run_attempt": "${{ github.run_attempt }}",
            "sha": "${{ github.sha }}",
            "ref": "${{ github.ref_name }}",
            "recorded_at_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF

      - name: Commit release gate marker
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(ci): record release gate marker [skip release-gate]"
          file_pattern: docs/release-gate-last-success.json
