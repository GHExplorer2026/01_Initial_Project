name: Release Gate

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "docs/release-gate-last-success.json"
  workflow_dispatch:
    inputs:
      target_ref:
        description: "Git ref to validate (branch, tag, or commit SHA)"
        required: false
        default: "main"

concurrency:
  group: release-gate-${{ github.ref }}
  cancel-in-progress: false

jobs:
  verify-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      NPM_CONFIG_REGISTRY: https://registry.npmjs.org/
      NODE_OPTIONS: --dns-result-order=ipv4first
      NPM_CONFIG_AUDIT: "false"
      NPM_CONFIG_FUND: "false"
      NPM_CONFIG_FETCH_RETRIES: "5"
      NPM_CONFIG_FETCH_RETRY_MINTIMEOUT: "20000"
      NPM_CONFIG_FETCH_RETRY_MAXTIMEOUT: "120000"
      NPM_CONFIG_LEGACY_PEER_DEPS: "true"

    steps:
      - name: Checkout target ref (manual)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_ref }}

      - name: Checkout current ref (push)
        if: github.event_name != 'workflow_dispatch'
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.20.0"

      - name: Install dependencies (retry + registry fallback)
        id: install
        continue-on-error: true
        run: |
          install_with_retry() {
            local registry="$1"
            for attempt in 1 2 3; do
              if npm ci --legacy-peer-deps --registry="${registry}"; then
                echo "npm ci succeeded via ${registry} (attempt ${attempt})"
                return 0
              fi
              echo "npm ci failed via ${registry} (attempt ${attempt}/3), retrying..."
              sleep $((attempt * 5))
            done
            return 1
          }

          if ! install_with_retry "$NPM_CONFIG_REGISTRY" && ! install_with_retry "https://registry.yarnpkg.com/"; then
            echo "npm ci failed on all configured registries"
            exit 1
          fi

      - name: Print tool versions
        if: always()
        run: |
          node -v
          npm -v

      - name: Run release verification gate
        id: verify
        continue-on-error: true
        run: npm run verify:release

      - name: Start app and run API smoke gate
        id: smoke
        continue-on-error: true
        run: |
          set -euo pipefail
          HOSTNAME=127.0.0.1 PORT=3000 node .next/standalone/server.js > /tmp/release-gate-app.log 2>&1 &
          APP_PID=$!
          cleanup() { kill "$APP_PID" >/dev/null 2>&1 || true; }
          trap cleanup EXIT

          for i in {1..90}; do
            if curl -fsS "http://127.0.0.1:3000/" >/dev/null; then
              break
            fi
            sleep 1
          done

          if ! curl -fsS "http://127.0.0.1:3000/" >/dev/null; then
            echo "App did not become ready on 127.0.0.1:3000"
            cat /tmp/release-gate-app.log || true
            exit 1
          fi
          set +e
          scripts/smoke_api.sh http://127.0.0.1:3000 USA,EZ > /tmp/release-gate-smoke.log 2>&1
          smoke_exit=$?
          set -e
          cat /tmp/release-gate-smoke.log || true
          if [ "${smoke_exit}" -ne 0 ]; then
            exit "${smoke_exit}"
          fi

      - name: Evaluate release gate status
        if: always()
        run: |
          echo "install=${{ steps.install.outcome }}"
          echo "verify=${{ steps.verify.outcome }}"
          echo "smoke=${{ steps.smoke.outcome }}"
          if [ "${{ steps.install.outcome }}" != "success" ] || [ "${{ steps.verify.outcome }}" != "success" ] || [ "${{ steps.smoke.outcome }}" != "success" ]; then
            exit 1
          fi

      - name: Upload release gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-gate-test-reports
          path: |
            artifacts/*.xml
            /tmp/release-gate-app.log
            /tmp/release-gate-smoke.log

      - name: Record release gate marker
        if: always()
        run: |
          mkdir -p docs
          smoke_log_tail_b64=""
          smoke_check_tail_b64=""
          if [ -f /tmp/release-gate-app.log ]; then
            smoke_log_tail_b64="$(tail -n 120 /tmp/release-gate-app.log | base64 -w 0)"
          fi
          if [ -f /tmp/release-gate-smoke.log ]; then
            smoke_check_tail_b64="$(tail -n 120 /tmp/release-gate-smoke.log | base64 -w 0)"
          fi
          cat > docs/release-gate-last-success.json <<EOF
          {
            "workflow": "Release Gate",
            "status": "${{ job.status }}",
            "step_outcomes": {
              "install": "${{ steps.install.outcome }}",
              "verify": "${{ steps.verify.outcome }}",
              "smoke": "${{ steps.smoke.outcome }}"
            },
            "run_id": "${{ github.run_id }}",
            "run_attempt": "${{ github.run_attempt }}",
            "sha": "${{ github.sha }}",
            "ref": "${{ github.ref_name }}",
            "recorded_at_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "smoke_log_tail_b64": "${smoke_log_tail_b64}",
            "smoke_check_tail_b64": "${smoke_check_tail_b64}"
          }
          EOF

      - name: Commit release gate marker
        if: always()
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git diff --quiet -- docs/release-gate-last-success.json; then
            echo "No marker changes to commit."
            exit 0
          fi

          git add docs/release-gate-last-success.json
          git commit -m "chore(ci): record release gate marker [skip release-gate]"

          for attempt in 1 2 3; do
            if git push origin "HEAD:${REF_NAME}"; then
              echo "Marker push succeeded (attempt ${attempt})."
              exit 0
            fi
            echo "Marker push failed (attempt ${attempt}), retrying with rebase..."
            git fetch origin "${REF_NAME}"
            git rebase "origin/${REF_NAME}"
          done

          echo "Failed to push release gate marker after retries."
          exit 1
